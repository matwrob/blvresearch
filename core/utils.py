from itertools import chain
import pandas as pd


start = lambda x: str(x) + "-01-01"
end = lambda x: str(x) + "-12-31"


@namespace
class db:

    fs = PostgresInterface('factset')
    ns = PostgresInterface('news')
    exch = list(chain(*EXCHANGES.values()))

    def potential_securities():  # pragma: no cover

        query = """SELECT s.FS_PERM_SEC_ID as fs_perm_sec_id
                   FROM fp_basic as s
                   INNER JOIN edm_standard_entity as e
                   ON (s.FACTSET_ENTITY_ID = e.FACTSET_ENTITY_ID)
                   WHERE FREF_LISTING_EXCHANGE = ANY(%s)
                   AND FS_SEC_TYPE IN ('PREF', 'PREFEQ','SHARE',
                                       'ADR', 'DR', 'GDR', 'UNIT')
                   AND e.INDUSTRY_CODE < '5000'
                   AND e.INDUSTRY_CODE is not NULL
                   AND e.ENTITY_TYPE IN ('PUB', 'SUB', 'EXT')
                   AND s.CURRENCY <> 'ZMW'"""
        res = db.fs.select(query, (db.exch,))
        return res.col('fs_perm_sec_id')

    def get_news_entities(start, end):  # pragma: no cover
        """gets the provider ids for all the news of a time period
        """
        query = """SELECT entities FROM news
                   WHERE story_time >= %s
                   AND story_time <= %s"""
        return db.ns.select(query, (start, end,)).col('entities')


SECTORS = ['1100',  # Non-Energy Minerals
           '1200',  # Producer Manufacturing
           '1300',  # Electronic Technology
           '1400',  # Consumer Durables
           '2100',  # Energy Minerals
           '2200',  # Process Industries
           '2300',  # Health Technology
           '2400',  # Consumer Non-Durables
           '3100',  # Industrial Services
           '3200',  # Commercial Services
           '3250',  # Distribution Services
           '3300',  # Technology Services
           '3350',  # Health Services
           '3400',  # Consumer Services
           '3500',  # Retail Trade
           '4600',  # Transportation
           '4700',  # Utilities
           '4800',  # Finance
           '4900',  # Communications
           '6000',  # Miscellaneous
           '7000',  # Government
           '9999']  # Not Classified


###############################################################################
###############################################################################
# risk-free rates
# source:
# http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/data_library.html#Research
# Direct link to file:
# http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/ftp/F-F_Research_Data_Factors.zip
# The 1-month TBill return is from Ibbotson and Associates, Inc.
###############################################################################
###############################################################################
RISK_FREE_RATES = {'2003-01-31': 0.10, '2003-02-28': 0.09, '2003-03-31': 0.10,
                   '2003-04-30': 0.10, '2003-05-31': 0.09, '2003-06-30': 0.10,
                   '2003-07-31': 0.07, '2003-08-31': 0.07, '2003-09-30': 0.08,
                   '2003-10-31': 0.07, '2003-11-30': 0.07, '2003-12-31': 0.08,
                   '2004-01-31': 0.07, '2004-02-29': 0.06, '2004-03-31': 0.09,
                   '2004-04-30': 0.08, '2004-05-31': 0.06, '2004-06-30': 0.08,
                   '2004-07-31': 0.10, '2004-08-31': 0.11, '2004-09-30': 0.11,
                   '2004-10-31': 0.11, '2004-11-30': 0.15, '2004-12-31': 0.16,
                   '2005-01-31': 0.16, '2005-02-28': 0.16, '2005-03-31': 0.21,
                   '2005-04-30': 0.21, '2005-05-31': 0.24, '2005-06-30': 0.23,
                   '2005-07-31': 0.24, '2005-08-31': 0.30, '2005-09-30': 0.29,
                   '2005-10-31': 0.27, '2005-11-30': 0.31, '2005-12-31': 0.32,
                   '2006-01-31': 0.35, '2006-02-28': 0.34, '2006-03-31': 0.37,
                   '2006-04-30': 0.36, '2006-05-31': 0.43, '2006-06-30': 0.40,
                   '2006-07-31': 0.40, '2006-08-31': 0.42, '2006-09-30': 0.41,
                   '2006-10-31': 0.41, '2006-11-30': 0.42, '2006-12-31': 0.40,
                   '2007-01-31': 0.44, '2007-02-28': 0.38, '2007-03-31': 0.43,
                   '2007-04-30': 0.44, '2007-05-31': 0.41, '2007-06-30': 0.40,
                   '2007-07-31': 0.40, '2007-08-31': 0.42, '2007-09-30': 0.32,
                   '2007-10-31': 0.32, '2007-11-30': 0.34, '2007-12-31': 0.27,
                   '2008-01-31': 0.21, '2008-02-29': 0.13, '2008-03-31': 0.17,
                   '2008-04-30': 0.18, '2008-05-31': 0.18, '2008-06-30': 0.17,
                   '2008-07-31': 0.15, '2008-08-31': 0.13, '2008-09-30': 0.15,
                   '2008-10-31': 0.08, '2008-11-30': 0.03, '2008-12-31': 0.00,
                   '2009-01-31': 0.00, '2009-02-28': 0.01, '2009-03-31': 0.02,
                   '2009-04-30': 0.01, '2009-05-31': 0.00, '2009-06-30': 0.01,
                   '2009-07-31': 0.01, '2009-08-31': 0.01, '2009-09-30': 0.01,
                   '2009-10-31': 0.00, '2009-11-30': 0.00, '2009-12-31': 0.01,
                   '2010-01-31': 0.00, '2010-02-28': 0.00, '2010-03-31': 0.01,
                   '2010-04-30': 0.01, '2010-05-31': 0.01, '2010-06-30': 0.01,
                   '2010-07-31': 0.01, '2010-08-31': 0.01, '2010-09-30': 0.01,
                   '2010-10-31': 0.01, '2010-11-30': 0.01, '2010-12-31': 0.01,
                   '2011-01-31': 0.01, '2011-02-28': 0.01, '2011-03-31': 0.01,
                   '2011-04-30': 0.00, '2011-05-31': 0.00, '2011-06-30': 0.00,
                   '2011-07-31': 0.00, '2011-08-31': 0.01, '2011-09-30': 0.00,
                   '2011-10-31': 0.00, '2011-11-30': 0.00, '2011-12-31': 0.00,
                   '2012-01-31': 0.00, '2012-02-29': 0.00, '2012-03-31': 0.00,
                   '2012-04-30': 0.00, '2012-05-31': 0.01, '2012-06-30': 0.00,
                   '2012-07-31': 0.00, '2012-08-31': 0.01, '2012-09-30': 0.01,
                   '2012-10-31': 0.01, '2012-11-30': 0.01, '2012-12-31': 0.01,
                   '2013-01-31': 0.00, '2013-02-28': 0.00, '2013-03-31': 0.00,
                   '2013-04-30': 0.00, '2013-05-31': 0.00, '2013-06-30': 0.00,
                   '2013-07-31': 0.00, '2013-08-31': 0.00, '2013-09-30': 0.00,
                   '2013-10-31': 0.00, '2013-11-30': 0.00, '2013-12-31': 0.00}

RF = pd.Series(RF)
