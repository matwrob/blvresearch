import pandas as pd
import numpy as np
import unittest

from blvresearch.concat.signals.price_based.rsi_agita import (
    get_rsi_signals, _calculate_rsi
)

PATH = 'blvresearch/tests/mock_ubs_data/ubs_alpha.csv'

MOCK_DATA = {'alpha': pd.Series.from_csv(PATH)}


class TestGetSignals(unittest.TestCase):

    def test_get1(self):
        res = get_rsi_signals(MOCK_DATA, periods=14, buy_thrsh=30,
                              sell_thrsh=70, mean_type='simple')
        exp = pd.Series(
            {'2012-07-06': True,
             '2012-08-22': False,
             '2012-11-30': True,
             '2013-01-24': False,
             '2013-02-15': True,
             '2013-04-19': False,
             '2013-07-10': True,
             '2013-07-23': False,
             '2013-09-30': True,
             '2014-01-13': False,
             '2014-02-24': True}
        )
        np.testing.assert_array_equal(res.dropna(), exp)

    def test_get2(self):
        res = get_rsi_signals(MOCK_DATA, periods=9, buy_thrsh=35,
                              sell_thrsh=65, mean_type='simple')
        exp = pd.Series(
           {'2012-06-29': True,
            '2012-08-22': False,
            '2012-09-04': True,
            '2012-09-06': False,
            '2012-09-26': True,
            '2012-10-15': False,
            '2012-11-28': True,
            '2012-12-12': False,
            '2012-12-21': True,
            '2013-01-14': False,
            '2013-01-25': True,
            '2013-03-15': False,
            '2013-03-19': True,
            '2013-04-11': False,
            '2013-05-16': True,
            '2013-06-06': False,
            '2013-07-03': True,
            '2013-07-19': False,
            '2013-09-24': True,
            '2013-10-11': False,
            '2013-10-23': True,
            '2013-11-15': False,
            '2013-11-22': True,
            '2013-11-28': False,
            '2013-12-17': True,
            '2014-01-07': False,
            '2014-01-24': True,
            '2014-02-04': False,
            '2014-02-17': True,
            '2014-04-30': False,
            '2014-05-13': True}
        )
        np.testing.assert_array_equal(res.dropna(), exp)


class TestCalculateRsi(unittest.TestCase):

    def test_calculate(self):
        res = _calculate_rsi(MOCK_DATA['alpha'], periods=9,
                             mean_type='simple')
        exp = pd.Series(
            {'2012-06-29': 27.75173453,
             '2012-07-02': 33.39121722,
             '2012-07-03': 30.25432194,
             '2012-07-04': 25.00684835,
             '2012-07-05': 14.17391491,
             '2012-07-06': 13.98571951,
             '2012-07-09': 16.48740977,
             '2012-07-10': 5.39310351,
             '2012-07-11': 12.11477059,
             '2012-07-12': 16.62651508,
             '2012-07-13': 9.547041644,
             '2012-07-16': 10.23344721,
             '2012-07-17': 11.07950711,
             '2012-07-18': 10.98879248,
             '2012-07-19': 11.212981,
             '2012-07-20': 7.993955043,
             '2012-07-23': 14.41707583,
             '2012-07-24': 17.86385963,
             '2012-07-25': 25.80512693,
             '2012-07-26': 32.47462572,
             '2012-07-27': 38.46249338,
             '2012-07-30': 55.28550111,
             '2012-07-31': 38.23275736,
             '2012-08-02': 40.74621096,
             '2012-08-03': 57.55978383,
             '2012-08-06': 55.27917775,
             '2012-08-07': 54.66912304,
             '2012-08-08': 46.28128635,
             '2012-08-09': 42.4528048,
             '2012-08-10': 40.14606853,
             '2012-08-13': 27.48785779,
             '2012-08-14': 51.53197252,
             '2012-08-15': 53.1915073,
             '2012-08-16': 40.27220469,
             '2012-08-17': 56.26106211,
             '2012-08-20': 37.92565984,
             '2012-08-21': 61.01667919,
             '2012-08-22': 73.87506171,
             '2012-08-23': 69.51486942,
             '2012-08-24': 59.534171,
             '2012-08-27': 64.84118497,
             '2012-08-28': 63.93950355,
             '2012-08-29': 63.81403612,
             '2012-08-30': 54.20449432,
             '2012-08-31': 64.42325687,
             '2012-09-03': 49.19871303,
             '2012-09-04': 27.00403016,
             '2012-09-05': 48.28404576,
             '2012-09-06': 68.55095898,
             '2012-09-07': 69.54140434,
             '2012-09-10': 76.27870962,
             '2012-09-11': 76.66270453,
             '2012-09-12': 87.91853869,
             '2012-09-13': 84.97201798,
             '2012-09-14': 93.24930734,
             '2012-09-17': 93.75046382,
             '2012-09-18': 73.61722019,
             '2012-09-19': 63.70597778,
             '2012-09-20': 54.04223867,
             '2012-09-21': 58.22429959,
             '2012-09-24': 51.56624687,
             '2012-09-25': 42.89718084,
             '2012-09-26': 34.71385905,
             '2012-09-27': 24.43477825,
             '2012-09-28': 23.95423884,
             '2012-10-01': 29.06720771,
             '2012-10-02': 32.57020548,
             '2012-10-03': 46.84864059,
             '2012-10-04': 37.78263407,
             '2012-10-05': 36.74385104,
             '2012-10-08': 32.21072632,
             '2012-10-09': 44.66632761,
             '2012-10-10': 46.20389129,
             '2012-10-11': 49.26751808,
             '2012-10-12': 64.4426737,
             '2012-10-15': 65.85681364,
             '2012-10-16': 62.2199418,
             '2012-10-17': 58.75545119,
             '2012-10-18': 73.0294,
             '2012-10-19': 59.05146526,
             '2012-10-22': 70.72403769,
             '2012-10-23': 72.29016068,
             '2012-10-24': 80.8310286,
             '2012-10-25': 78.78946067,
             '2012-10-26': 68.48156754,
             '2012-10-29': 83.29080605,
             '2012-10-30': 87.45342049,
             '2012-10-31': 87.72859635,
             '2012-11-01': 95.41813916,
             '2012-11-02': 90.85012748,
             '2012-11-05': 90.67953537,
             '2012-11-06': 90.36851168,
             '2012-11-07': 90.64249614,
             '2012-11-08': 95.2878825022,
             '2012-11-09': 84.49622987,
             '2012-11-12': 75.14884338,
             '2012-11-13': 71.20059484,
             '2012-11-14': 54.51702799,
             '2012-11-15': 75.17554977,
             '2012-11-16': 60.2834595,
             '2012-11-19': 55.04292321,
             '2012-11-20': 42.90144302,
             '2012-11-21': 44.4773137,
             '2012-11-22': 52.60532292,
             '2012-11-23': 44.08222522,
             '2012-11-26': 41.21810337,
             '2012-11-27': 39.83436496,
             '2012-11-28': 14.04319398,
             '2012-11-29': 14.91260844,
             '2012-11-30': 9.965162309,
             '2012-12-03': 12.17821115,
             '2012-12-04': 11.38560107,
             '2012-12-05': 24.5275412,
             '2012-12-06': 25.27139537,
             '2012-12-07': 26.05397603,
             '2012-12-10': 29.31199517,
             '2012-12-11': 44.31130321,
             '2012-12-12': 70.91365595,
             '2012-12-13': 78.96036784,
             '2012-12-14': 70.51872738,
             '2012-12-17': 61.31779942,
             '2012-12-18': 59.18598201,
             '2012-12-19': 48.81432711,
             '2012-12-20': 42.71377868,
             '2012-12-21': 34.81034974,
             '2012-12-27': 27.66120825,
             '2012-12-28': 16.00145867,
             '2013-01-03': 14.00797509,
             '2013-01-04': 12.1814966,
             '2013-01-07': 28.02701728,
             '2013-01-08': 23.95489547,
             '2013-01-09': 43.07246831,
             '2013-01-10': 46.50554041,
             '2013-01-11': 59.89620428,
             '2013-01-14': 70.20869496,
             '2013-01-15': 70.46443961,
             '2013-01-16': 75.97762211,
             '2013-01-17': 78.427385,
             '2013-01-18': 70.10186344,
             '2013-01-21': 71.02718279,
             '2013-01-22': 54.61517459,
             '2013-01-23': 48.29957331,
             '2013-01-24': 52.03466842,
             '2013-01-25': 34.76420765,
             '2013-01-28': 46.74564929,
             '2013-01-29': 50.42283541,
             '2013-01-30': 48.87138621,
             '2013-01-31': 48.89529697,
             '2013-02-01': 40.40089524,
             '2013-02-04': 39.87454875,
             '2013-02-05': 38.72593667,
             '2013-02-06': 31.48751101,
             '2013-02-07': 32.87314836,
             '2013-02-08': 11.14455772,
             '2013-02-11': 6.151343202,
             '2013-02-12': 33.70755727,
             '2013-02-13': 28.02150746,
             '2013-02-14': 28.89002791,
             '2013-02-15': 25.45750958,
             '2013-02-18': 29.69401962,
             '2013-02-19': 24.2576385029,
             '2013-02-20': 25.51835995,
             '2013-02-21': 27.1213344,
             '2013-02-22': 27.11113603,
             '2013-02-25': 2.218079552,
             '2013-02-26': 3.106986552,
             '2013-02-27': 3.507294117,
             '2013-02-28': 3.545452983,
             '2013-03-01': 0.01981304894,
             '2013-03-04': 0.01722793763,
             '2013-03-05': 5.626046592,
             '2013-03-06': 18.24542179,
             '2013-03-07': 20.75055224,
             '2013-03-08': 30.9071122686,
             '2013-03-11': 30.68247814,
             '2013-03-12': 27.80142763,
             '2013-03-13': 39.29101899,
             '2013-03-14': 50.45363109,
             '2013-03-15': 72.81947199,
             '2013-03-18': 51.38164861,
             '2013-03-19': 28.22908464,
             '2013-03-20': 26.94427564,
             '2013-03-21': 22.86994239,
             '2013-03-22': 33.67555473,
             '2013-03-25': 37.66654661,
             '2013-03-26': 34.93156773,
             '2013-03-27': 23.28216889,
             '2013-03-28': 20.18443129,
             '2013-04-02': 23.81457862,
             '2013-04-03': 30.64603675,
             '2013-04-04': 46.79857523,
             '2013-04-05': 54.99347616,
             '2013-04-08': 38.48467678,
             '2013-04-09': 54.57688513,
             '2013-04-10': 59.29178463,
             '2013-04-11': 68.84152692,
             '2013-04-12': 69.42406768,
             '2013-04-15': 73.93937104,
             '2013-04-16': 81.36471668,
             '2013-04-17': 79.45781553,
             '2013-04-18': 61.79831349,
             '2013-04-19': 76.62173044,
             '2013-04-22': 74.10257566,
             '2013-04-23': 66.60469238,
             '2013-04-24': 64.156582,
             '2013-04-25': 70.47582374,
             '2013-04-26': 61.00716168,
             '2013-04-29': 52.39805202,
             '2013-04-30': 73.41483334,
             '2013-05-02': 86.55570993,
             '2013-05-03': 81.52685785,
             '2013-05-06': 76.8066426,
             '2013-05-07': 83.21264837,
             '2013-05-08': 76.60465203,
             '2013-05-10': 76.43191005,
             '2013-05-13': 74.43758654,
             '2013-05-14': 76.04955981,
             '2013-05-15': 56.20226977,
             '2013-05-16': 34.37820155,
             '2013-05-17': 54.44435501,
             '2013-05-21': 58.39389894,
             '2013-05-22': 57.26256197,
             '2013-05-23': 60.65904984,
             '2013-05-24': 51.9041059,
             '2013-05-27': 61.61024527,
             '2013-05-28': 59.54624279,
             '2013-05-29': 48.7977431,
             '2013-05-30': 54.20297746,
             '2013-05-31': 41.58756503,
             '2013-06-03': 55.63270933,
             '2013-06-04': 57.22616719,
             '2013-06-05': 62.02460981,
             '2013-06-06': 76.51716972,
             '2013-06-07': 80.50215388,
             '2013-06-10': 68.40548334,
             '2013-06-11': 63.21153424,
             '2013-06-12': 51.24685742,
             '2013-06-13': 53.93570731,
             '2013-06-14': 49.86407979,
             '2013-06-17': 41.29155755,
             '2013-06-18': 40.01291219,
             '2013-06-19': 36.60280507,
             '2013-06-20': 43.09648077,
             '2013-06-21': 45.78272475,
             '2013-06-24': 56.76380241,
             '2013-06-25': 64.28164308,
             '2013-06-26': 51.43310966,
             '2013-06-27': 38.71502418,
             '2013-06-28': 39.12813652,
             '2013-07-01': 41.45965111,
             '2013-07-02': 40.4883042,
             '2013-07-03': 20.76143265,
             '2013-07-04': 23.4399574981,
             '2013-07-05': 4.136405303,
             '2013-07-08': 4.007304439,
             '2013-07-09': 4.007943005,
             '2013-07-10': 4.435232028,
             '2013-07-11': 7.977100496,
             '2013-07-12': 5.613589636,
             '2013-07-15': 6.897830568,
             '2013-07-16': 36.88344813,
             '2013-07-17': 50.8174151,
             '2013-07-18': 62.70927663,
             '2013-07-19': 75.93174144,
             '2013-07-22': 90.29396001,
             '2013-07-23': 98.09918344,
             '2013-07-24': 98.08756388,
             '2013-07-25': 98.82611677,
             '2013-07-26': 100,
             '2013-07-29': 95.83100239,
             '2013-07-30': 96.06322219,
             '2013-07-31': 95.61703564,
             '2013-08-02': 95.15360437,
             '2013-08-05': 91.04860971,
             '2013-08-06': 62.70169213,
             '2013-08-07': 60.95930856,
             '2013-08-08': 61.91638789,
             '2013-08-09': 51.81199642,
             '2013-08-12': 60.48685456,
             '2013-08-13': 57.51329004,
             '2013-08-14': 59.75181836,
             '2013-08-15': 57.24200665,
             '2013-08-16': 63.63502024,
             '2013-08-19': 61.43023032,
             '2013-08-20': 54.68825906,
             '2013-08-21': 54.51155737,
             '2013-08-22': 65.29644236,
             '2013-08-23': 61.27404901,
             '2013-08-26': 44.46712488,
             '2013-08-27': 35.93773757,
             '2013-08-28': 48.55771344,
             '2013-08-29': 37.64305634,
             '2013-08-30': 51.58282726,
             '2013-09-02': 66.9590128,
             '2013-09-03': 62.50798157,
             '2013-09-04': 58.44988988,
             '2013-09-05': 58.57354355,
             '2013-09-06': 44.8470018597,
             '2013-09-09': 54.29823788,
             '2013-09-10': 44.78968384,
             '2013-09-11': 58.19296733,
             '2013-09-12': 59.90933247,
             '2013-09-13': 62.72565861,
             '2013-09-16': 58.39879656,
             '2013-09-17': 57.97543858,
             '2013-09-18': 46.45694501,
             '2013-09-19': 59.5197908,
             '2013-09-20': 49.7398405,
             '2013-09-23': 35.19554764,
             '2013-09-24': 26.47421801,
             '2013-09-25': 21.76920845,
             '2013-09-26': 8.745826335,
             '2013-09-27': 8.23012406,
             '2013-09-30': 3.238216711,
             '2013-10-01': 28.06184249,
             '2013-10-02': 37.45650652,
             '2013-10-03': 34.61661961,
             '2013-10-04': 52.92047081,
             '2013-10-07': 38.58686678,
             '2013-10-08': 43.78627572,
             '2013-10-09': 51.09474419,
             '2013-10-10': 63.45891937,
             '2013-10-11': 68.75413302,
             '2013-10-14': 58.24819491,
             '2013-10-15': 61.99615283,
             '2013-10-16': 68.937073,
             '2013-10-17': 63.22989387,
             '2013-10-18': 70.73943784,
             '2013-10-21': 63.20854326,
             '2013-10-22': 47.14501915,
             '2013-10-23': 25.53753457,
             '2013-10-24': 21.83335924,
             '2013-10-25': 30.208737,
             '2013-10-28': 29.5071985027,
             '2013-10-29': 11.98738097,
             '2013-10-30': 10.5197759,
             '2013-10-31': 11.01560921,
             '2013-11-01': 11.52422564,
             '2013-11-04': 8.780490714,
             '2013-11-05': 13.59146552,
             '2013-11-06': 14.95495562,
             '2013-11-07': 11.79884583,
             '2013-11-08': 9.246002766,
             '2013-11-11': 18.83644653,
             '2013-11-12': 26.21118669,
             '2013-11-13': 29.47322719,
             '2013-11-14': 31.57980697,
             '2013-11-15': 73.55138823,
             '2013-11-18': 62.24625308,
             '2013-11-19': 46.12677452,
             '2013-11-20': 45.22355039,
             '2013-11-21': 43.22155139,
             '2013-11-22': 32.07947024,
             '2013-11-25': 46.80101242,
             '2013-11-26': 48.08099781,
             '2013-11-27': 48.00060469,
             '2013-11-28': 67.07670799,
             '2013-11-29': 65.10506835,
             '2013-12-02': 74.25317998,
             '2013-12-03': 69.54995275,
             '2013-12-04': 74.21996487,
             '2013-12-05': 75.37113705,
             '2013-12-06': 69.9485156,
             '2013-12-09': 62.21134578,
             '2013-12-10': 58.73100531,
             '2013-12-11': 46.07249319,
             '2013-12-12': 46.29692118,
             '2013-12-13': 41.12441213,
             '2013-12-16': 47.92839793,
             '2013-12-17': 15.48553961,
             '2013-12-18': 15.1007479149,
             '2013-12-19': 20.53639192,
             '2013-12-20': 32.43518063,
             '2013-12-23': 29.40412897,
             '2013-12-27': 18.00538217,
             '2013-12-30': 16.13484103,
             '2014-01-03': 23.73021361,
             '2014-01-06': 43.09239085,
             '2014-01-07': 67.20512755,
             '2014-01-08': 82.32748164,
             '2014-01-09': 82.54091682,
             '2014-01-10': 72.87478478,
             '2014-01-13': 82.24817522,
             '2014-01-14': 83.3235024,
             '2014-01-15': 90.114153,
             '2014-01-16': 90.35296488,
             '2014-01-17': 89.55078988,
             '2014-01-20': 74.97035447,
             '2014-01-21': 56.80104672,
             '2014-01-22': 50.90143615,
             '2014-01-23': 51.37610683,
             '2014-01-24': 27.01488543,
             '2014-01-27': 38.85753624,
             '2014-01-28': 42.75502973,
             '2014-01-29': 31.80971914,
             '2014-01-30': 26.59281943,
             '2014-01-31': 33.47119127,
             '2014-02-03': 30.67734898,
             '2014-02-04': 68.74996527,
             '2014-02-05': 69.5693133,
             '2014-02-06': 60.37852832,
             '2014-02-07': 52.85775007,
             '2014-02-10': 50.69103767,
             '2014-02-11': 49.83321176,
             '2014-02-12': 53.58586077,
             '2014-02-13': 52.82559958,
             '2014-02-14': 55.39304672,
             '2014-02-17': 14.85656725,
             '2014-02-18': 22.87725543,
             '2014-02-19': 26.82319381,
             '2014-02-20': 40.37765129,
             '2014-02-21': 36.04951977,
             '2014-02-24': 38.63338663,
             '2014-02-25': 19.76537701,
             '2014-02-26': 23.41237538,
             '2014-02-27': 48.70285107,
             '2014-02-28': 52.64752323,
             '2014-03-03': 39.44983277,
             '2014-03-04': 45.50315119,
             '2014-03-05': 41.75559548,
             '2014-03-06': 43.18738358,
             '2014-03-07': 48.39095917,
             '2014-03-10': 54.70903812,
             '2014-03-11': 51.45224391,
             '2014-03-12': 19.7965271,
             '2014-03-13': 47.40794383,
             '2014-03-14': 38.78464818,
             '2014-03-17': 33.36741034,
             '2014-03-18': 38.52475222,
             '2014-03-19': 38.41870276,
             '2014-03-20': 54.39519825,
             '2014-03-21': 45.53725851,
             '2014-03-24': 46.02817752,
             '2014-03-25': 42.30889109,
             '2014-03-26': 30.29501744,
             '2014-03-27': 36.10558171,
             '2014-03-28': 36.66558159,
             '2014-03-31': 36.72207034,
             '2014-04-01': 48.31047879,
             '2014-04-02': 30.83958769,
             '2014-04-03': 40.00687741,
             '2014-04-04': 34.29429399,
             '2014-04-07': 35.24099349,
             '2014-04-08': 32.49248146,
             '2014-04-09': 35.60200747,
             '2014-04-10': 36.71709742,
             '2014-04-11': 28.08283107,
             '2014-04-14': 0,
             '2014-04-15': 0,
             '2014-04-16': 0,
             '2014-04-17': 28.6465054,
             '2014-04-22': 43.50314426,
             '2014-04-23': 47.3423253,
             '2014-04-24': 49.65992492,
             '2014-04-25': 44.52141768,
             '2014-04-28': 50.579891,
             '2014-04-29': 64.06980786,
             '2014-04-30': 68.65567033,
             '2014-05-02': 74.67177929,
             '2014-05-05': 60.68187685,
             '2014-05-06': 60.57376695,
             '2014-05-07': 66.95613816,
             '2014-05-08': 62.28082844,
             '2014-05-09': 55.78993999,
             '2014-05-12': 47.27173627,
             '2014-05-13': 30.12606306,
             '2014-05-14': 39.51003415,
             '2014-05-15': 23.71397483,
             '2014-05-16': 27.27208023,
             '2014-05-19': 16.58324162,
             '2014-05-20': 13.73490051,
             '2014-05-21': 27.83521073,
             '2014-05-22': 28.17162548,
             '2014-05-23': 33.97188248,
             '2014-05-26': 34.11495596,
             '2014-05-27': 28.48928715,
             '2014-05-28': 58.32136473,
             '2014-05-30': 44.21883459,
             '2014-06-02': 53.72222097,
             '2014-06-03': 51.02680408,
             '2014-06-04': 34.97699362,
             '2014-06-05': 37.0775938,
             '2014-06-06': 42.98477454,
             '2014-06-10': 48.6269991,
             '2014-06-11': 39.94823724,
             '2014-06-12': 25.90706724,
             '2014-06-13': 27.34470695,
             '2014-06-16': 18.97657164,
             '2014-06-17': 22.29902569,
             '2014-06-18': 27.16064144}
        )
        np.testing.assert_array_almost_equal(res.dropna(), exp)
